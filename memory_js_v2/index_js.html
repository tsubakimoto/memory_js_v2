<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="utf-8" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>神経衰弱ゲーム</title>
    <style>
        input {
            font-size: 18px;
        }
    </style>
</head>
<body>
    <h1>神経衰弱ゲーム</h1>
    <p>Score: <span id="score"></span></p>
    <input type="button" id="card_0" value="?" />
    <input type="button" id="card_1" value="?" /><br />
    <input type="button" id="card_2" value="?" />
    <input type="button" id="card_3" value="?" />

    <script>
        (function () {
            var cards = [],
                CAR_NUM = 4,
                currentNum,
                openedCard,
                correctNum = 0,
                enableFlip = true,
                score = 0,
                timerId;

            function flip(n) {
                if (!enableFlip) {
                    // ジャッジ中のフリップは無効
                    return;
                }
                var card = document.getElementById('card_' + n);
                if (card.value != '?') {
                    return;
                }
                card.value = cards[n];
                if (typeof currentNum === 'undefined') {
                    // 1枚目
                    openedCard = n;
                    currentNum = cards[n];
                } else {
                    // 2枚目
                    judge(n);
                    currentNum = undefined;
                }
            }

            function judge(n) {
                if (currentNum == cards[n]) {
                    // 正解
                    correctNum++;
                    if (correctNum == CAR_NUM / 2) {
                        clearTimeout(timerId);
                        alert("your score is " + document.getElementById('score').innerHTML);
                    }
                } else {
                    // 不正解
                    enableFlip = false;
                    setTimeout(function () {
                        document.getElementById('card_' + openedCard).value = '?';
                        document.getElementById('card_' + n).value = '?';
                        enableFlip = true;
                    }, 700);
                }
            }

            function initCards() {
                var num,
                    cardIndex,
                    i;
                for (i = 0; i < CAR_NUM; i++) {
                    num = Math.floor(i / 2);
                    do {
                        cardIndex = Math.floor(Math.random() * CAR_NUM);
                    } while (typeof cards[cardIndex] !== 'undefined');
                    cards[cardIndex] = num;
                }
                //console.log(cards);
                var el = document.getElementsByTagName('input');
                for (i = 0; i < el.length; i++) {
                    el[i].onclick = function () {
                        flip(this.id.replace(/^card_/, ''))
                    }
                }
            }

            function runTimer() {
                document.getElementById('score').innerHTML = score++;
                timerId = setTimeout(function () {
                    runTimer();
                }, 10);
            }

            initCards();
            runTimer();
        })();
    </script>
</body>
</html>
